<!DOCTYPE html>
<html lang="zh_CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>qrcode sample zxing js browser camera</title>
    <script>
        if (location.protocol === 'http') {
            location.protocol = 'https';
        }
    </script>

    <script src="https://unpkg.com/@zxing/browser@0.1.1/umd/zxing-browser.min.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }

        .cover-console {
            margin: 0;
            position: fixed;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100%;
            background: #8888;
            overflow: scroll;
        }
    </style>
</head>
<body>
<div>
    <div>
        <button id="showBtn">Show</button>
        <button id="stopBtn">Stop</button>
        <button id="startBtn">Start</button>
    </div>

    <div>
        <video id="preVideo" style="max-width: 100%;height: 75vh;"></video>
    </div>

</div>

<pre class="cover-console" id="coverConsole">
    <button id="hideBtn" style="position: sticky;top: 12px;">Hide</button>
</pre>

<script>
    const coverConsole = document.getElementById('coverConsole');
    const preVideo = document.getElementById('preVideo');
    const showBtn = document.getElementById('showBtn');
    const hideBtn = document.getElementById('hideBtn');
    const stopBtn = document.getElementById('stopBtn');
    const startBtn = document.getElementById('startBtn');

    const append = obj => {
        coverConsole.append(JSON.stringify(obj, null, 3));
        coverConsole.append('\n');
        coverConsole.scrollTo(0, coverConsole.scrollHeight);
    };

    const codeReader = new ZXingBrowser.BrowserQRCodeReader();
    let controls = null;

    hideBtn.addEventListener('click', () => {
        coverConsole.hidden = true;
    });
    showBtn.addEventListener('click', () => {
        coverConsole.hidden = false;
    });
    stopBtn.addEventListener('click', () => {
        if (controls) {
            controls.stop();
            controls = null;
        }
    });
    startBtn.addEventListener('click', () => {
        if (!controls) {
            (async function () {
                const videoInputDevs = await ZXingBrowser.BrowserQRCodeReader.listVideoInputDevices();
                append(videoInputDevs);

                if (videoInputDevs.length) {
                    const selDevId = videoInputDevs[1].deviceId;

                    controls = await codeReader.decodeFromVideoDevice(selDevId, preVideo, (res, err, controls) => {
                        if (res) {
                            append(res);
                        }
                    });
                } else {
                    append('no camera found. ~o_o~');
                }
            })();

            showBtn.click();
        }
    });

    startBtn.click();
</script>
</body>
</html>
